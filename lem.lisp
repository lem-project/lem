(in-package :lem)

(export '(find-keybind
          universal-argument
          self-insert
          lem))

(defvar *running-p* nil)

(define-key *global-keymap* (kbd "C-g") 'keyboard-quit)
(define-command keyboard-quit () ()
  (error 'editor-abort))

(defun find-keybind (key)
  (let ((cmd (or (some #'(lambda (mode)
                           (keymap-find-keybind (mode-keymap mode) key))
                       (buffer-minor-modes))
                 (keymap-find-keybind (mode-keymap (buffer-major-mode)) key)
                 (keymap-find-keybind *global-keymap* key))))
    (function-to-command cmd)))

(define-key *global-keymap* (kbd "C-u") 'universal-argument)
(define-command universal-argument () ()
  (let ((numlist)
        n)
    (do ((c (minibuf-read-char "C-u 4")
            (minibuf-read-char
             (format nil "C-u 狺铛盱轶舂┅铋飑ㄣ镱è汨狎铆酴箦赳铛盱轶磲疸狎т殓轸汨狎ㄣ镥蜚ㄦ矧磲铋幄íㄩ铛盱轶疳蝮瀛轭翦珏ㄦ矧磲铋狺铛盱轶舂穿┅ъ轶舂┅è犷ㄣ栳蚪＼铛祆铛盱轶舂箦赳铛盱轶ㄡ痧孱铛盱轶扉篝＼┅┅è箦赳ㄤ殓轸汨狎悌箦赳铛盱轶ㄡ痧孱铛盱轶扉篝瞟┅躅蝈徜脲悌戾è狎ㄩ铛盱轶疳蝮瀛轭翦珏ㄦ矧磲铋狺铛盱轶舂穿┅蝈趱蝾ㄦ躅汜祆ㄦ轭洵脲忾钿蝈徜脲箦聃孱沐┅狎绌┅┅┅ㄤ彐轭瀛泔眄犷箦戽轭箦螋瞟á稷戾èㄩ铙弪糸镱脲灬篝蝈徜脲箦聃孱沐┅ㄣ镱ㄣㄩ铙弪舡汨狎瞟ㄥ溟麸颦弪蝻⑺妁铒骘躅浜幄脞洵麸篝蜷铉灬篝蝈徜脲箦聃孱沐┅┅┅ㄤ彐躅祜徜轭轸骈戾īㄦ戾è翦篝疳翳麒孱ㄣ飙驷浜骈戾屮轶趔疳翳祜徜疳翳礤篌徵⑻镝骈戾幄疳翳舂┅矧翦篝礤蜱瀛疳翳钺礤㈧屙蜚趄蹂钺礤┅翦篝礤蜱瀛疳翳钺礤戾眚恽躞弪栾礤溟颦疳翳钺礤┅┅┅ㄤ彐躅痫瘐瓠忉汶趄徙ㄣ镱溟糸镱ㄩ铈锃痫瘐ㄧ弭怩骀弪泸遽翦膨蝻颡＇灬礅溽秕舂痱轭泔钿轸轱秕舂ㄦ蝈箬扉铄秕舂蹰镳轫徵搴痱轭舡忉汶趄徙后趄遽秕恒秕铘卑癌┅ㄤ彐磲泸鏖翳弪蝻颦栳钿戾è怙澌怙澌啜栳钿戾颦汜箦忾钿ǎЖ灬礅溽ㄣ镱溟糸镱ㄨ犷潇弪忾钿è弪蝻＇忉殪秕舂痫瘐瓠忉汶趄徙泔钿轸轱瞟┅棱镤è泔钿轸轱瞟ㄤ邈灬蝈ㄩ珙矧泔钿轸轱瞟┅┅ㄤ彐躅戾憝磲轭ī磲泸镬弭è骘蝽é怙澌怙澌啜泔钿í溴怩绛皙ㄨ犷潇弪忾钿è弪蝻＇忉殪秕舂＋筲沆筲簌蠛轭翦蜥泗轹瀛轭翦蝌躔＇忉殪秕舂棱镤┅棱镤┅┅ㄤè沲蝌骒徵螵磲脲骒徵螬磲脲骒徵螬í灬篝骒徵螵磲脲骒徵螬沲蝌骒徵螵┅铋飑鏖翳弪蝻颦栳钿戾īㄦ矧蝈潋狩溟箴灬戾舄è脲蝈徜脲箦聃孱沐┅ㄣ礓ㄦ轭洵脲忾钿脲┅礤篌徵铋飑ㄨ犷潇弪汜箦ㄨ犷潇弪忾钿è邃轸矧泔钿轸轱灬礅溽ㄣㄤ邈灬蝈ㄩ珙矧悌篝镳蝈泔蜾脲┅┅ㄣ礓汜祆沩铋飑ㄥ溟麸颦徕矧īㄢ蹑驽颦磲螂汜钽屐ㄣ躜蝈铘怩骀弪┅礤篌徵⒀蹰簪┅蝈徜镱禊ī礤篌徵⒁遽项禊┅ㄥ溟麸颦弪蝻ㄣ礤篌徵ㄥ溟麸颦弪蝻颦礤篌徵悌┅┅┅┅戾è疳篌邃铋飑ㄤ彐躅戾憝轭轸ㄡ蜱螬翦蝽轭轸箦赳蝓铑轭绛皙舂麒孱铒疳篌邃箦赳疳篌邃舂ㄤ轶痨狴轭轸鏖钿秣轭轸黹铋怩姝轭轸鏖翳弪蝻颦栳钿戾ī祜徜轭轸骈戾┅ㄤ镬轶ㄡ蜱狎珞ㄦ轭洵骈戾狎绌┅ㄤ彐躅戾憝骈钺祆辁ī翦蝽骈钺祆辁濠箦赳蝓铑轭绛皙铋飑ㄤ彐鲠屮轸翎绔ㄧ孱簌⑴厣寓┅ㄤ彐躅屮轸邃轸矧é镳糸镱犰蝈痫螋翳蝻屮轸翎绔蝈痫螋┅ㄤ彐躅戾憝ㄡ蜱螬戾è蝈痫螋ㄣ狒汨屮轸翎绔躅鏖钿痱雉邈痱镧戾憝轭轸狎珞戾憝磲轭┅戾憝骈钺祆辁濠┅┅麒孱蝈痫螋ㄦ矧磲狺ア蝈痫螋┅┅ㄤ彐躅汨邈氕轭轸ī麒孱蝓铑轭绛皙ㄥ蝌矧轶犰蝈徜蝓铑轭纰痱镧蜥憝钺礤┅ㄤ彐躅戾é蝈篝狎珞ㄣ桢汶轭轸戾憝狎珞┅ㄤ彐躅忉殪秕ㄣ镱溟糸镱ㄥ轸邃轸矧鏖翳秕麴豸麸篝蜷铉篝蝈犴痱轭泔钿轸轱篝蝈犴蹰镳轫徵搴痱轭舡忉汶趄徙后趄遽篝蝈犴恒镱溟糸镱泔钿轸轱瞟┅