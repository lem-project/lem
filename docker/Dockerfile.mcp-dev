FROM fukamachi/qlot:latest

USER root
RUN apt-get update && apt-get install -y \
    build-essential \
    libssl-dev \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app
COPY . .

# Install dependencies
RUN qlot install

# Expose micros server port
EXPOSE 4005

# Start micros server for remote Lem connection
CMD ["exec", "sbcl", "--noinform", \
     "--eval", "(ql:quickload '(:micros :lem-mcp-server) :silent t)", \
     "--eval", "(format t \"~%MCP Server loaded. Starting micros on port 4005...~%\")", \
     "--eval", "(micros:create-server :port 4005 :interface \"0.0.0.0\" :dont-close t)", \
     "--eval", "(format t \"~%micros server running. Connect from Lem with M-x slime-connect~%\")", \
     "--eval", "(loop (sleep 3600))"]
