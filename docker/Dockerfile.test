FROM fukamachi/qlot:latest

USER root
RUN apt-get update && apt-get install -y \
    build-essential \
    libssl-dev \
    git \
    nodejs \
    npm \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Install tree-sitter CLI and LSP servers
RUN npm install -g tree-sitter-cli typescript-language-server typescript

# Install Go 1.23 and gopls
ENV GOROOT=/usr/local/go
ENV GOPATH=/go
ENV PATH=$PATH:$GOROOT/bin:$GOPATH/bin
RUN curl -fsSL https://go.dev/dl/go1.23.4.linux-amd64.tar.gz | tar -C /usr/local -xzf - && \
    go install golang.org/x/tools/gopls@latest

# Build tree-sitter library from source (Ubuntu package may be too old)
WORKDIR /tmp
RUN git clone --depth 1 https://github.com/tree-sitter/tree-sitter.git && \
    cd tree-sitter && \
    make && \
    make install && \
    ldconfig

# Build tree-sitter grammars for testing
RUN git clone --depth 1 https://github.com/tree-sitter/tree-sitter-json.git && \
    cd tree-sitter-json && \
    cc -shared -fPIC -o /usr/local/lib/libtree-sitter-json.so -I src src/parser.c

RUN git clone --depth 1 https://github.com/ikatyang/tree-sitter-yaml.git && \
    cd tree-sitter-yaml && \
    cc -c -fPIC -I src src/parser.c -o parser.o && \
    c++ -c -fPIC -I src src/scanner.cc -o scanner.o && \
    c++ -shared -o /usr/local/lib/libtree-sitter-yaml.so parser.o scanner.o

RUN ldconfig

WORKDIR /app
COPY . .

# Install dependencies
RUN qlot install

# Run tests using qlot exec (fukamachi/qlot image uses qlot as entrypoint)
CMD ["exec", "bash", "-c", ".qlot/bin/rove lem-tests.asd && .qlot/bin/rove extensions/vi-mode/lem-vi-mode.asd"]
