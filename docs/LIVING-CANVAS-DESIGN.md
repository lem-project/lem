# Living Canvas - è¨­è¨ˆæ›¸

Lemã‚¨ãƒ‡ã‚£ã‚¿ã®æ–°æ©Ÿèƒ½ã€ŒLiving Canvasã€ã®è¨­è¨ˆãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã€‚

## æ¦‚è¦

Living Canvasã¯ã€ã‚³ãƒ¼ãƒ‰ã‚’**é–¢æ•°ãƒãƒ¼ãƒ‰ã¨ã‚¨ãƒƒã‚¸ã®ã‚°ãƒ©ãƒ•**ã¨ã—ã¦å¯è¦–åŒ–ã—ã€
**Figmaãƒ©ã‚¤ã‚¯ãªã‚­ãƒ£ãƒ³ãƒã‚¹**ä¸Šã§æ“ä½œã§ãã‚‹é©æ–°çš„ãªæ©Ÿèƒ½ã§ã™ã€‚

### ãƒ“ã‚¸ãƒ§ãƒ³

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Figma-like Canvas                                          â”‚
â”‚                                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚   â”‚ main     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ parse    â”‚â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ validate â”‚    â”‚
â”‚   â”‚          â”‚         â”‚          â”‚        â”‚   âš¡å®Ÿè¡Œä¸­ â”‚    â”‚
â”‚   â”‚ [ğŸ“AI]   â”‚         â”‚ [ğŸ“AI]   â”‚        â”‚          â”‚    â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚        â”‚                                         â”‚          â”‚
â”‚        â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚          â”‚
â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ log      â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                       â”‚          â”‚                          â”‚
â”‚                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
â”‚                                                             â”‚
â”‚   [ä»˜ç®‹: "ã“ã®é–¢æ•°ã‚’ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ä»˜ãã§æ›¸ãç›´ã—ã¦"]      â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å·®åˆ¥åŒ–ãƒã‚¤ãƒ³ãƒˆ

| æ—¢å­˜ãƒ„ãƒ¼ãƒ« | Living Canvas |
|-----------|---------------|
| ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚° â†’ ãƒ†ã‚­ã‚¹ãƒˆã®ä»£æ›¿ | ãƒ†ã‚­ã‚¹ãƒˆ**ã¨**ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«ã®èåˆ |
| é™çš„ã‚³ãƒ¼ãƒ«ã‚°ãƒ©ãƒ• | **å‹•çš„**å®Ÿè¡ŒçŠ¶æ…‹ã®å¯è¦–åŒ– |
| AIã¯ãƒãƒ£ãƒƒãƒˆã§åˆ†é›¢ | AIãŒ**ã‚­ãƒ£ãƒ³ãƒã‚¹ä¸Šã«çµ±åˆ** |
| ã‚³ãƒ¼ãƒ‰ç·¨é›†ã¯åˆ¥ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ | **åŒä¸€ã‚­ãƒ£ãƒ³ãƒã‚¹**ã§å…¨ã¦å®Œçµ |

---

## ãƒ•ã‚§ãƒ¼ã‚ºåˆ¥è¨ˆç”»

### Phase 1: åŸºç›¤ï¼ˆã‚°ãƒ©ãƒ•å¯è¦–åŒ–ï¼‰

**ç›®æ¨™**: ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®é–¢æ•°ã‚’ã‚°ãƒ©ãƒ•ã¨ã—ã¦è¡¨ç¤ºã—ã€åŸºæœ¬æ“ä½œã‚’å¯èƒ½ã«ã™ã‚‹

**æ©Ÿèƒ½**:
- é–¢æ•°ã‚’ãƒãƒ¼ãƒ‰ã¨ã—ã¦è¡¨ç¤º
- é–¢æ•°å‘¼ã³å‡ºã—ã‚’ã‚¨ãƒƒã‚¸ã¨ã—ã¦è¡¨ç¤º
- ãƒãƒ¼ãƒ‰ã®ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—
- ãƒãƒ¼ãƒ‰ã‚¯ãƒªãƒƒã‚¯ã§ã‚½ãƒ¼ã‚¹ã«ã‚¸ãƒ£ãƒ³ãƒ—
- è‡ªå‹•ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼ˆdagreï¼‰

### Phase 2: å®Ÿè¡Œå¯è¦–åŒ–

**ç›®æ¨™**: ã‚³ãƒ¼ãƒ‰ã®å®Ÿè¡ŒçŠ¶æ…‹ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§å¯è¦–åŒ–

**æ©Ÿèƒ½**:
- traceçµ±åˆã«ã‚ˆã‚‹å®Ÿè¡Œè¿½è·¡
- å®Ÿè¡Œä¸­ã®é–¢æ•°ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
- ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—
- å‘¼ã³å‡ºã—å›æ•°ã®è¡¨ç¤º

### Phase 3: AIçµ±åˆ

**ç›®æ¨™**: ä»˜ç®‹ã‚’é€šã˜ã¦AIã¨é€£æº

**æ©Ÿèƒ½**:
- ãƒãƒ¼ãƒ‰ã«ä»˜ç®‹ã‚’è¿½åŠ 
- ä»˜ç®‹ã«ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’è¨˜è¿°
- AIã«ã‚ˆã‚‹ã‚³ãƒ¼ãƒ‰ç”Ÿæˆ
- ç”Ÿæˆçµæœã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¨é©ç”¨

### Phase 4: æ™‚é–“è»¸ç·¨é›†

**ç›®æ¨™**: ç·¨é›†å±¥æ­´ã‚’æ™‚é–“è»¸ã§ç®¡ç†

**æ©Ÿèƒ½**:
- ç·¨é›†å±¥æ­´ã®ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³è¡¨ç¤º
- ä»»æ„ã®æ™‚ç‚¹ã¸ã®ã‚¸ãƒ£ãƒ³ãƒ—
- 2æ™‚ç‚¹é–“ã®å·®åˆ†è¡¨ç¤º
- ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆæ©Ÿèƒ½

---

## ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

### å…¨ä½“æ§‹æˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Living Canvas                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚     WebView Frontend (HTML/CSS/JS)              â”‚   â”‚
â”‚  â”‚     - Cytoscape.js for graph rendering          â”‚   â”‚
â”‚  â”‚     - ãƒãƒ¼ãƒ‰æç”»ã€ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—                â”‚   â”‚
â”‚  â”‚     - å®Ÿè¡ŒçŠ¶æ…‹ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å¯è¦–åŒ–                 â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                         â†• JSON-RPC                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚         Lem Core (Common Lisp)                  â”‚   â”‚
â”‚  â”‚     - ãƒãƒƒãƒ•ã‚¡/ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ç®¡ç†                     â”‚   â”‚
â”‚  â”‚     - Lispè©•ä¾¡ã‚¨ãƒ³ã‚¸ãƒ³                           â”‚   â”‚
â”‚  â”‚     - ã‚³ãƒ¼ãƒ«ã‚°ãƒ©ãƒ•è§£æ                            â”‚   â”‚
â”‚  â”‚     - AI APIçµ±åˆ                                 â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ—¢å­˜æ©Ÿèƒ½ã®æ´»ç”¨

| æ—¢å­˜æ©Ÿèƒ½ | ç”¨é€” |
|---------|------|
| `html-buffer` | Canvasè¡¨ç¤ºã®ãƒ™ãƒ¼ã‚¹ã‚¯ãƒ©ã‚¹ |
| `change-view-to-html` | Viewã‚’HTMLãƒ¢ãƒ¼ãƒ‰ã«åˆ‡æ›¿ |
| `js-eval` | Lispâ†’JSé€šä¿¡ï¼ˆã‚°ãƒ©ãƒ•æ›´æ–°ç­‰ï¼‰ |
| `register-method` | JSâ†’Lispé€šä¿¡ï¼ˆã‚¤ãƒ™ãƒ³ãƒˆå—ä¿¡ï¼‰ |

### ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ

```
extensions/
â””â”€â”€ living-canvas/
    â”œâ”€â”€ lem-living-canvas.asd       # ã‚·ã‚¹ãƒ†ãƒ å®šç¾©
    â”œâ”€â”€ package.lisp                # ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸å®šç¾©
    â”œâ”€â”€ call-graph.lisp             # é–¢æ•°å‘¼ã³å‡ºã—ã‚°ãƒ©ãƒ•è§£æ
    â”œâ”€â”€ canvas-buffer.lisp          # Canvasãƒãƒƒãƒ•ã‚¡ã‚¯ãƒ©ã‚¹
    â”œâ”€â”€ commands.lisp               # ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚³ãƒãƒ³ãƒ‰
    â””â”€â”€ trace.lisp                  # å®Ÿè¡Œè¿½è·¡ (Phase 2)
```

---

## ãƒ‡ãƒ¼ã‚¿æ§‹é€ 

### Lispå´

```lisp
;; ãƒãƒ¼ãƒ‰ã®è¡¨ç¾
(defstruct graph-node
  id              ; ãƒ¦ãƒ‹ãƒ¼ã‚¯ID (ã‚·ãƒ³ãƒœãƒ«å + ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸)
  name            ; é–¢æ•°å
  package         ; ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸å
  type            ; :function, :macro, :generic-function
  docstring       ; ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ–‡å­—åˆ—
  source-location ; (file . line-number)
  position)       ; (x . y) ã‚­ãƒ£ãƒ³ãƒã‚¹ä¸Šã®ä½ç½®

;; ã‚¨ãƒƒã‚¸ã®è¡¨ç¾
(defstruct graph-edge
  source          ; å‘¼ã³å‡ºã—å…ƒãƒãƒ¼ãƒ‰ID
  target          ; å‘¼ã³å‡ºã—å…ˆãƒãƒ¼ãƒ‰ID
  call-type)      ; :direct, :funcall, :apply

;; ã‚°ãƒ©ãƒ•å…¨ä½“
(defstruct call-graph
  nodes           ; ãƒãƒ¼ãƒ‰ã®ãƒãƒƒã‚·ãƒ¥ãƒ†ãƒ¼ãƒ–ãƒ«
  edges           ; ã‚¨ãƒƒã‚¸ã®ãƒªã‚¹ãƒˆ
  root-package)   ; è§£æå¯¾è±¡ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸
```

### JSON-RPC API

#### Lisp â†’ JavaScript

| ãƒ¡ã‚½ãƒƒãƒ‰ | èª¬æ˜ | ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ |
|---------|------|-----------|
| `canvas:init` | ã‚­ãƒ£ãƒ³ãƒã‚¹åˆæœŸåŒ– | `{width, height, theme}` |
| `canvas:update-graph` | ã‚°ãƒ©ãƒ•æ›´æ–° | `{nodes, edges}` |
| `canvas:highlight-node` | ãƒãƒ¼ãƒ‰ãƒã‚¤ãƒ©ã‚¤ãƒˆ | `{nodeId, color}` |
| `canvas:set-node-position` | ãƒãƒ¼ãƒ‰ä½ç½®è¨­å®š | `{nodeId, x, y}` |

#### JavaScript â†’ Lisp

| ãƒ¡ã‚½ãƒƒãƒ‰ | èª¬æ˜ | ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ |
|---------|------|-----------|
| `canvas:node-clicked` | ãƒãƒ¼ãƒ‰ã‚¯ãƒªãƒƒã‚¯ | `{nodeId}` |
| `canvas:node-moved` | ãƒãƒ¼ãƒ‰ç§»å‹•å®Œäº† | `{nodeId, x, y}` |
| `canvas:request-refresh` | ã‚°ãƒ©ãƒ•å†è¨ˆç®—è¦æ±‚ | `{packageName}` |
| `canvas:open-source` | ã‚½ãƒ¼ã‚¹è¡¨ç¤ºè¦æ±‚ | `{nodeId}` |

---

## Phase 1 è©³ç´°å®Ÿè£…

### call-graph.lisp

```lisp
(defpackage :lem-living-canvas/call-graph
  (:use :cl)
  (:export #:analyze-package
           #:analyze-buffer
           #:get-callees
           #:graph-to-json))
(in-package :lem-living-canvas/call-graph)

;; é–¢æ•°æœ¬ä½“ã‹ã‚‰ã‚·ãƒ³ãƒœãƒ«å‚ç…§ã‚’æŠ½å‡º
(defun extract-called-functions (form)
  "ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰å‘¼ã³å‡ºã•ã‚Œã¦ã„ã‚‹é–¢æ•°ã‚’æŠ½å‡ºã™ã‚‹"
  (let ((calls '()))
    (labels ((walk (form)
               (cond
                 ((symbolp form)
                  (when (fboundp form)
                    (pushnew form calls)))
                 ((consp form)
                  (case (car form)
                    ((function)
                     (when (symbolp (cadr form))
                       (pushnew (cadr form) calls)))
                    ((funcall apply)
                     (when (and (consp (cadr form))
                                (eq 'function (caadr form)))
                       (pushnew (cadadr form) calls)))
                    (otherwise
                     (mapc #'walk form)))))))
      (walk form))
    calls))

;; ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸å†…ã®å…¨é–¢æ•°ã‚’è§£æ
(defun analyze-package (package-designator)
  "æŒ‡å®šãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®é–¢æ•°å‘¼ã³å‡ºã—ã‚°ãƒ©ãƒ•ã‚’æ§‹ç¯‰ã™ã‚‹"
  (let ((package (find-package package-designator))
        (nodes (make-hash-table :test 'eq))
        (edges '()))
    (do-symbols (sym package)
      (when (and (fboundp sym)
                 (eq (symbol-package sym) package))
        ;; ãƒãƒ¼ãƒ‰ä½œæˆ
        (setf (gethash sym nodes)
              (make-graph-node
               :id (format nil "~A:~A"
                           (package-name package)
                           (symbol-name sym))
               :name (symbol-name sym)
               :package (package-name package)
               :type (cond ((macro-function sym) :macro)
                           ((typep (fdefinition sym) 'generic-function)
                            :generic-function)
                           (t :function))
               :docstring (documentation sym 'function)
               :source-location (get-source-location sym)))
        ;; ã‚¨ãƒƒã‚¸ä½œæˆ
        (let ((callees (get-callees sym)))
          (dolist (callee callees)
            (when (gethash callee nodes)
              (push (make-graph-edge
                     :source sym
                     :target callee
                     :call-type :direct)
                    edges))))))
    (make-call-graph :nodes nodes :edges edges :root-package package)))
```

### canvas-buffer.lisp

```lisp
(defpackage :lem-living-canvas/buffer
  (:use :cl :lem)
  (:export #:canvas-buffer
           #:make-canvas-buffer
           #:canvas-buffer-graph
           #:canvas-buffer-source-buffer
           #:update-canvas))
(in-package :lem-living-canvas/buffer)

(defclass canvas-buffer (html-buffer)
  ((graph :initarg :graph
          :accessor canvas-buffer-graph
          :documentation "ã‚³ãƒ¼ãƒ«ã‚°ãƒ©ãƒ•ãƒ‡ãƒ¼ã‚¿")
   (source-buffer :initarg :source-buffer
                  :accessor canvas-buffer-source-buffer
                  :documentation "è§£æå¯¾è±¡ã®ã‚½ãƒ¼ã‚¹ãƒãƒƒãƒ•ã‚¡")
   (node-positions :initform (make-hash-table :test 'equal)
                   :accessor canvas-buffer-node-positions
                   :documentation "ãƒãƒ¼ãƒ‰ä½ç½®ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥")))

(defun make-canvas-buffer (name source-buffer graph)
  "Canvasãƒãƒƒãƒ•ã‚¡ã‚’ä½œæˆã™ã‚‹"
  (let ((buffer (make-buffer name)))
    (change-class buffer 'canvas-buffer
                  :graph graph
                  :source-buffer source-buffer
                  :html (generate-canvas-html graph))
    buffer))
```

### commands.lisp

```lisp
(defpackage :lem-living-canvas/commands
  (:use :cl :lem)
  (:export #:living-canvas
           #:living-canvas-refresh
           #:living-canvas-jump-to-source))
(in-package :lem-living-canvas/commands)

;; JSâ†’Lisp ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ç™»éŒ²
(lem-server:register-method "canvas:node-selected"
  (lambda (args)
    (let ((node-id (gethash "nodeId" args)))
      (message "Selected: ~A" node-id))))

(lem-server:register-method "canvas:open-source"
  (lambda (args)
    (let ((node-id (gethash "nodeId" args)))
      (lem:send-event
       (lambda ()
         (jump-to-node-source node-id))))))

(lem-server:register-method "canvas:node-moved"
  (lambda (args)
    (let ((node-id (gethash "nodeId" args))
          (x (gethash "x" args))
          (y (gethash "y" args)))
      (save-node-position node-id x y))))

;; ãƒ¡ã‚¤ãƒ³ã‚³ãƒãƒ³ãƒ‰
(define-command living-canvas (package-name) ((:string "Package: "))
  "ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®é–¢æ•°å‘¼ã³å‡ºã—ã‚°ãƒ©ãƒ•ã‚’Canvasã§è¡¨ç¤º"
  (let* ((source-buffer (current-buffer))
         (graph (analyze-package package-name))
         (canvas-buffer (make-canvas-buffer
                         (format nil "*Canvas: ~A*" package-name)
                         source-buffer
                         graph)))
    (pop-to-buffer canvas-buffer)))

(define-command living-canvas-current-buffer () ()
  "ç¾åœ¨ã®ãƒãƒƒãƒ•ã‚¡ã®é–¢æ•°ã‚°ãƒ©ãƒ•ã‚’è¡¨ç¤º"
  (let* ((buffer (current-buffer))
         (package (or (buffer-package buffer) *package*)))
    (living-canvas (package-name package))))

(define-command living-canvas-refresh () ()
  "Canvasã‚’æ›´æ–°"
  (when (typep (current-buffer) 'canvas-buffer)
    (let* ((buffer (current-buffer))
           (source-buffer (canvas-buffer-source-buffer buffer))
           (graph (analyze-buffer source-buffer)))
      (setf (canvas-buffer-graph buffer) graph)
      (js-eval (current-window)
               (format nil "updateGraph(~A)"
                       (graph-to-cytoscape-json graph))))))
```

---

## JavaScriptå´å®Ÿè£…

### Canvas Surface (Cytoscape.js)

```javascript
// canvas-surface.js
const cy = cytoscape({
  container: document.getElementById('cy'),
  style: [
    {
      selector: 'node',
      style: {
        'background-color': '#3c3c3c',
        'border-color': '#5a5a5a',
        'border-width': 2,
        'label': 'data(name)',
        'color': '#d4d4d4',
        'text-valign': 'center',
        'text-halign': 'center',
        'font-size': '11px',
        'font-family': 'Consolas, monospace',
        'width': 'label',
        'height': 32,
        'padding': '12px',
        'shape': 'roundrectangle'
      }
    },
    {
      selector: 'node[type="macro"]',
      style: { 'border-color': '#c586c0' }
    },
    {
      selector: 'node[type="generic-function"]',
      style: { 'border-color': '#4ec9b0' }
    },
    {
      selector: 'edge',
      style: {
        'width': 1.5,
        'line-color': '#454545',
        'target-arrow-color': '#454545',
        'target-arrow-shape': 'triangle',
        'curve-style': 'bezier'
      }
    },
    {
      selector: 'node:selected',
      style: {
        'border-color': '#007acc',
        'border-width': 3,
        'background-color': '#264f78'
      }
    },
    {
      selector: '.executing',
      style: {
        'background-color': '#4a9eff',
        'border-color': '#2d7ad9'
      }
    }
  ],
  layout: {
    name: 'dagre',
    rankDir: 'LR',
    nodeSep: 50,
    rankSep: 80
  }
});

// ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©
cy.on('tap', 'node', (e) => {
  invokeLem('canvas:node-selected', { nodeId: e.target.id() });
});

cy.on('dbltap', 'node', (e) => {
  invokeLem('canvas:open-source', { nodeId: e.target.id() });
});

cy.on('dragfree', 'node', (e) => {
  const pos = e.target.position();
  invokeLem('canvas:node-moved', {
    nodeId: e.target.id(),
    x: pos.x,
    y: pos.y
  });
});

// Lispå´ã‹ã‚‰å‘¼ã³å‡ºã•ã‚Œã‚‹é–¢æ•°
window.updateGraph = (data) => {
  cy.json({ elements: data.elements });
  cy.layout({ name: 'dagre', rankDir: 'LR' }).run();
};

window.highlightNode = (nodeId) => {
  cy.$('.executing').removeClass('executing');
  cy.$('#' + nodeId).addClass('executing');
};
```

---

## å®Ÿè£…é †åº

### Phase 1 å®Ÿè£…ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«

```
Week 1: åŸºç›¤
â”œâ”€â”€ [1] call-graph.lisp - é–¢æ•°æŠ½å‡ºã¨ä¾å­˜è§£æ
â”œâ”€â”€ [2] package.lisp + .asd - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹é€ 
â””â”€â”€ [3] åŸºæœ¬çš„ãªJSONå‡ºåŠ›

Week 2: è¡¨ç¤º
â”œâ”€â”€ [4] canvas-surface.js - Cytoscapeçµ±åˆ
â”œâ”€â”€ [5] canvas-mode.lisp - ãƒ¢ãƒ¼ãƒ‰å®šç¾©
â””â”€â”€ [6] HTMLç”Ÿæˆã¨WebViewçµ±åˆ

Week 3: ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³
â”œâ”€â”€ [7] ãƒãƒ¼ãƒ‰ã‚¯ãƒªãƒƒã‚¯ â†’ ã‚½ãƒ¼ã‚¹ã‚¸ãƒ£ãƒ³ãƒ—
â”œâ”€â”€ [8] ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—
â””â”€â”€ [9] ä½ç½®ã®æ°¸ç¶šåŒ–

Week 4: ä»•ä¸Šã’
â”œâ”€â”€ [10] ã‚¹ã‚¿ã‚¤ãƒ«èª¿æ•´
â”œâ”€â”€ [11] ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
â””â”€â”€ [12] ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
```

---

## å°†æ¥ã®æ‹¡å¼µ

### Phase 2: å®Ÿè¡Œå¯è¦–åŒ–

```lisp
;; trace-integration.lisp
(defun notify-canvas-enter (fn-name)
  "é–¢æ•°å‘¼ã³å‡ºã—é–‹å§‹ã‚’Canvasã«é€šçŸ¥"
  (when (canvas-visible-p)
    (js-eval-async
     (format nil "highlightNode('~A')" fn-name))))
```

### Phase 3: AIçµ±åˆ

```lisp
;; ä»˜ç®‹ãƒ‡ãƒ¼ã‚¿
(defstruct sticky-note
  id              ; ãƒ¦ãƒ‹ãƒ¼ã‚¯ID
  node-id         ; é–¢é€£ã™ã‚‹ãƒãƒ¼ãƒ‰ID
  content         ; ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ†ã‚­ã‚¹ãƒˆ
  ai-response     ; AIç”Ÿæˆçµæœ
  status)         ; :pending, :generating, :ready, :applied
```

### Phase 4: æ™‚é–“è»¸

```lisp
;; ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆ
(defstruct graph-snapshot
  timestamp
  graph-data
  buffer-state
  description)
```

---

## å…¨ä½“ãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—

```
Phase 1 (åŸºç›¤)          Phase 2 (å®Ÿè¡Œå¯è¦–åŒ–)
â”œâ”€â”€ é–¢æ•°æŠ½å‡º            â”œâ”€â”€ traceçµ±åˆ
â”œâ”€â”€ ã‚°ãƒ©ãƒ•æç”»          â”œâ”€â”€ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒã‚¤ãƒ©ã‚¤ãƒˆ
â”œâ”€â”€ ãƒãƒ¼ãƒ‰æ“ä½œ          â””â”€â”€ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è¡¨ç¤º
â””â”€â”€ ã‚½ãƒ¼ã‚¹ã‚¸ãƒ£ãƒ³ãƒ—
        â”‚                       â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â–¼
            Phase 3 (AIçµ±åˆ)
            â”œâ”€â”€ ä»˜ç®‹ã‚·ã‚¹ãƒ†ãƒ 
            â”œâ”€â”€ AIå‘¼ã³å‡ºã—
            â””â”€â”€ ã‚³ãƒ¼ãƒ‰é©ç”¨
                    â”‚
                    â–¼
            Phase 4 (æ™‚é–“è»¸)
            â”œâ”€â”€ å±¥æ­´ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³
            â”œâ”€â”€ ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆ
            â””â”€â”€ å·®åˆ†è¡¨ç¤º
                    â”‚
                    â–¼
              â˜… è¦‡æ¨©ã¸ã®é“ â˜…
```

---

## ä½œæˆæ—¥

2025-12-13

## é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- [ARCHITECTURE.md](./ARCHITECTURE.md) - Lemã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£
- [extension-development.md](./extension-development.md) - æ‹¡å¼µé–‹ç™ºã‚¬ã‚¤ãƒ‰
